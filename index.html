<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>DienstOrbit – Dienstplan-Generator</title>

  <!-- Meta -->
  <meta name="application-name" content="DienstOrbit" />
  <meta name="author" content="Wolfgang Saal" />
  <meta name="description" content="Dienstplan im Orbit: smart planen, sauber exportieren. DienstOrbit ist ein Dienstplan-Generator mit Berücksichtigung von Ferien & Feiertagen nach Bundesland. Export: CSV, PDF, ICS, Excel." />
  <meta name="robots" content="index,follow" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#1e40af" />

  <!-- Tailwind (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top:    env(safe-area-inset-top, 0px);
    }

    .error-msg { color:#dc2626;font-size:.8rem;margin-top:.25rem;display:none; }
    .hint-msg  { color:#6b7280;font-size:.7rem;margin-top:.25rem; }
    .feiertag-row { background-color:#fff8dc; }
    .auto-badge{ margin-left:8px;font-size:.70rem;background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:9999px;vertical-align:middle; }
    .disabled-btn{ opacity:.5;cursor:not-allowed; }
    .legend-box{ border:1px solid #e5e7eb;background:#f9fafb;border-radius:.75rem;padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:.75rem;color:#4b5563;font-size:.7rem; }
    footer{ border:1px solid #e5e7eb;background:#f9fafb;border-radius:.75rem;padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:.75rem;color:#3967a8;text-align:center;font-size:.675rem; }
    footer a{ color:inherit;text-decoration:underline; }

    /* Fallback-Sichtbarkeit sicherstellen */
    .logo-fallback.hidden { display: none !important; }
    .app-logo .hidden { display: none !important; }

    /* === App-Header === */
    .app-header{
      border:1px solid #e5e7eb; border-radius:1rem;
      padding:1rem 1.25rem; margin-bottom:.75rem;
      background: linear-gradient(135deg,#eff6ff 0%,#ffffff 65%);
      box-shadow: 0 10px 24px rgba(30,64,175,.08), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .app-header-inner{
      display:grid; grid-template-columns:auto 1fr; gap:1rem; align-items:center;
    }
    .app-logo{ position:relative; }
    .logo-img{
      display:block;
      max-height:64px; width:auto; height:auto; object-fit:contain;
    }
    .logo-fallback{
      display:flex; align-items:center; justify-content:center;
      height:64px; width:64px; border-radius:14px;
      background:#1e40af; color:#fff; font-weight:800; font-size:1.25rem;
      box-shadow:0 6px 16px rgba(30,64,175,.25);
    }
    .app-title{ margin:0; font-size:clamp(1.25rem,2.1vw + .6rem,2rem); line-height:1.1; font-weight:900; color:#1e40af; }
    .app-subtitle{ margin-top:.15rem; font-weight:700; color:#1e40af; }
    .app-subline{ margin-top:.15rem; font-size:.80rem; color:#374151; }

    @media (min-width:768px){
      .app-header-inner{ grid-template-columns:auto 1fr; gap:1.25rem; }
      .logo-fallback{ height:80px; width:80px; }
      .logo-img{ max-height:80px; width:auto; height:auto; object-fit:contain; }
    }

    /* Collapsible */
    .chevron{ transition: transform .2s ease; }
    .chevron[aria-expanded="true"]{ transform: rotate(180deg); }
    .collapsible { overflow: hidden; transition: max-height .26s ease, opacity .26s ease; opacity: 0; max-height: 0; will-change: max-height, opacity; }
    .collapsible.open { opacity: 1; }
    @media (prefers-reduced-motion: reduce) { .collapsible { transition: none; } }

    /* Fehlerfelder */
    .error-field { border-color:#ef4444 !important; box-shadow: 0 0 0 1px rgba(239,68,68,.35) inset; }
    .error-field:focus { outline: none; box-shadow: 0 0 0 2px rgba(239,68,68,.45) inset; }

    /* Floating Buttons */
    .float-btn { position: fixed; right: 1.25rem; z-index: 70; opacity: 0; transform: translateY(8px); pointer-events: none; transition: opacity .2s ease, transform .2s ease; }
    .float-btn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .to-top     { bottom: calc(1.25rem + var(--safe-bottom)); }
    .to-export  { bottom: calc(1.25rem + var(--safe-bottom)); right: 6rem; }
    .to-results { bottom: calc(8.25rem + var(--safe-bottom)); }
    @media (prefers-reduced-motion: reduce) { .float-btn { transition: none; } }

    /* === Ergebnis-Tabelle: Card + Optik === */
    .table-card{
      border:1px solid #e5e7eb; border-radius:0.75rem;
      background:#fff; overflow:hidden;
      box-shadow: 0 6px 24px rgba(17,24,39,.06);
    }

    /* eigener Scroll-Wrapper für Mobile, damit die Card weiterhin overflow:hidden haben darf */
    .table-scroll{ width:100%; overflow-x:visible; }
    @media (max-width: 767px){
      .table-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    }

    #ergebnisTabelle{ border-collapse: separate; border-spacing: 0; font-variant-numeric: tabular-nums; width:100%; }
    #ergebnisTabelle th, #ergebnisTabelle td{ border-color:#e5e7eb; }

    /* Sticky-Header */
    #ergebnisTabelle thead th{
      position: sticky; top: 0; z-index: 1;
      background: linear-gradient(180deg, #eff6ff 0%, #eaf2ff 100%);
      color:#1e3a8a;
      box-shadow: inset 0 -1px 0 #e5e7eb;
    }

    /* Zebra + Hover */
    #ergebnisTabelle tbody tr:nth-child(even):not(.feiertag-row){ background:#f9fafb; }
    #ergebnisTabelle tbody tr:hover{ background:#eef2ff; }

    /* linke Akzentlinie */
    #ergebnisTabelle tbody tr.wknd td:first-child{ box-shadow: inset 4px 0 0 #e5e7eb; }
    #ergebnisTabelle tbody tr.feiertag-row td:first-child{ box-shadow: inset 4px 0 0 #f59e0b; }

    @media (min-width: 768px){
      #ergebnisTabelle th, #ergebnisTabelle td{ padding-top: .6rem; padding-bottom: .6rem; }
    }

    /* kleine Status-Badges */
    .chip{ display:inline-block; margin-left:.5rem; padding:2px 8px; font-size:.65rem; line-height:1; border-radius:9999px; vertical-align:middle; border:1px solid transparent; }
    .chip-cancel{ background:#fef2f2; color:#b91c1c; border-color:#fecaca; }
    .chip-info{   background:#fff7ed; color:#9a3412; border-color:#fed7aa; }

    /* Toolbar + Sortierung + No-Results */
    .table-toolbar{
      display:flex; gap:.75rem; align-items:center; justify-content:space-between;
      padding:.6rem .9rem; border-bottom:1px solid #e5e7eb; background:#f8fafc;
    }
    .table-toolbar.hidden{ display:none; }
    .table-toolbar .left, .table-toolbar .right{
      display:flex; align-items:center; gap:.5rem;
    }
    .table-toolbar .left{ flex:1 1 auto; flex-wrap:nowrap; }
    .table-search{
      appearance:none; border:1px solid #d1d5db; background:#fff; color:#111827;
      border-radius:.5rem; padding:.625rem .75rem; font-size:.95rem;
      flex: 1 1 18rem; min-width:12rem; max-width:30rem;
    }
    .table-search:focus{ outline:2px solid #93c5fd; outline-offset:1px; border-color:#60a5fa; }
    .table-count{ font-size:.8rem; color:#6b7280; white-space:nowrap; }

    #ergebnisTabelle thead th.sortable{ cursor:pointer; user-select:none; position:sticky; top:0; z-index:2; padding-right:1.25rem; }
    #ergebnisTabelle thead th .sort-ind{
      position:absolute; right:.5rem; top:50%; transform:translateY(-50%) rotate(0deg);
      font-size:.85rem; color:#64748b; opacity:.7; transition:transform .15s ease, opacity .15s ease;
    }
    #ergebnisTabelle thead th.sorted-asc  .sort-ind{ transform:translateY(-50%) rotate(180deg); opacity:1; }
    #ergebnisTabelle thead th.sorted-desc .sort-ind{ transform:translateY(-50%) rotate(0deg);   opacity:1; }
    #ergebnisTabelle thead th.sorted-asc, #ergebnisTabelle thead th.sorted-desc{ color:#0f2167; }

    .row-hidden{ display:none; }
    .no-results{
      padding:1rem 1.25rem; color:#6b7280; font-size:.9rem; text-align:center;
      border-top:1px dashed #e5e7eb; background:#fafafa;
    }

    /* === MOBILE / TABLET TUNING === */
    @media (max-width: 767px){
      body{ padding: .75rem; }
      .app-header{ padding: .75rem .9rem; }
      .app-header-inner{ grid-template-columns: 1fr; gap:.5rem; }
      .app-logo{ order:1; }
      .app-titlewrap{ order:2; }
      .logo-fallback{ height:56px;width:56px; }
      .logo-img{ max-height:56px; }

      /* Formularfelder: größere Hit-Area */
      input[type="checkbox"]{ width:1.25rem; height:1.25rem; }

      /* Buttons: etwas kompakter, aber fingerfreundlich */
      button{ min-height: 44px; }

      /* Aktionen/Export Abstände */
      #exportButtons, .legend-box{ margin-bottom: .25rem; }

      /* Toolbar sticky unter Tabellenkopf */
      .table-toolbar{
        position: sticky; top: 0; z-index: 3;
        border-bottom:1px solid #e5e7eb; background:#f8fafc;
      }
      .table-toolbar{ flex-wrap:wrap; gap:.5rem; }
      .table-toolbar .left{ flex-wrap:wrap; }
      .table-search{
        flex: 1 1 100%;
        min-width: 0;
        width:100%;
        font-size:1rem;
      }
      #tableCount{ width:100%; text-align:right; }

      /* Tabelle: kleinere Zellen + horizontales Scrollen (über .table-scroll) */
      #ergebnisTabelle{ font-size:.95rem; min-width: 640px; }
      #ergebnisTabelle th, #ergebnisTabelle td{ padding:.5rem .6rem; }

      /* Scroll-Hinweis-Schatten am rechten Rand */
      .table-scroll{
        background:
          linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,1)),
          linear-gradient(to right, rgba(0,0,0,.08), rgba(0,0,0,0));
        background-position: left center, right center;
        background-repeat: no-repeat;
        background-size: 20px 100%, 12px 100%;
        mask: linear-gradient(to right, white 0, white calc(100% - 12px), transparent 100%);
      }
    }

    @media (min-width:768px) and (max-width:1023px){
      /* Tablet-Feinschliff */
      .table-search{ flex:1 0 22rem; }
      #ergebnisTabelle{ font-size:1rem; }
    }
  
    /* === Tablet-Fix für die Felder-Grid (Start/Ende Datum/Zeit) === */
    .terminreihe .field-grid{
      display: grid;
      /* sorgt für saubere Abstände UND automatisches Umbrechen,
         wenn 2 Spalten nebeneinander zu eng würden */
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      column-gap: 1rem;   /* ~ Tailwind gap-4 horizontal */
      row-gap: .75rem;    /* ~ Tailwind gap-3 vertikal   */
    }

    /* Auf großem Screen wieder strikt 2 Spalten behalten (wie vorher) */
    @media (min-width: 1024px){
      .terminreihe .field-grid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
        column-gap: 1rem;
        row-gap: .75rem;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-blue-100 min-h-screen p-6">

  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="app-header" role="banner" aria-label="DienstOrbit">
      <div class="app-header-inner">
        <div class="app-logo">
          <img id="brandLogo" alt="DienstOrbit Logo" class="logo-img hidden" />
          <div id="brandFallback" class="logo-fallback" aria-hidden="true">DO</div>
        </div>
        <div class="app-titlewrap">
          <h1 id="pageTop" class="app-title sr-only">DienstOrbit – Dienstplan-Generator</h1>
          <p class="app-subtitle">Dienstpläne im Orbit: smart planen, sauber exportieren</p>
          <p class="app-subline">Dienstplan-Generator mit Berücksichtigung von Ferien &amp; Feiertagen und diversen Export-Modulen.</p>
        </div>
      </div>
    </header>

    <!-- Allgemeine Angaben -->
    <div class="space-y-4 border border-gray-200 rounded-xl bg-gray-50 p-4 shadow-sm">
      <h3 class="text-xl font-extrabold text-blue-700 uppercase mb-2">Allgemeine Angaben</h3>

      <label class="block font-medium">Name des Ortsverband:
        <input type="text" id="ov_name" class="w-full border border-blue-200 rounded-lg px-3 py-2 mt-1" aria-describedby="error_ov_name">
        <p id="error_ov_name" class="error-msg">Bitte geben Sie den Namen des Ortsverbands ein.</p>
      </label>

      <div class="flex flex-col md:flex-row md:items-center md:gap-6">
        <label class="block w-full font-medium">Bundesland zur Ferien- und Feiertagsermittlung:
          <select id="bundesland" class="w-full border border-blue-200 rounded-lg px-3 py-2 mt-1" aria-describedby="error_bundesland">
            <option value="">Bitte wählen</option>
            <option value="BW">Baden-Württemberg</option><option value="BY">Bayern</option>
            <option value="BE">Berlin</option><option value="BB">Brandenburg</option>
            <option value="HB">Bremen</option><option value="HH">Hamburg</option>
            <option value="HE">Hessen</option><option value="MV">Mecklenburg-Vorpommern</option>
            <option value="NI">Niedersachsen</option><option value="NW">Nordrhein-Westfalen</option>
            <option value="RP">Rheinland-Pfalz</option><option value="SL">Saarland</option>
            <option value="SN">Sachsen</option><option value="ST">Sachsen-Anhalt</option>
            <option value="SH">Schleswig-Holstein</option><option value="TH">Thüringen</option>
          </select>
          <p id="error_bundesland" class="error-msg">Bitte wählen Sie ein Bundesland aus. Wird für die Feiertags- &amp; Ferien-Ermittlung benötigt.</p>
        </label>

        <div class="flex gap-6 items-center mt-4 md:mt-7">
          <label class="inline-flex items-center">
            <input type="checkbox" id="feiertagsCheck" class="form-checkbox h-5 w-5 text-blue-600"/>
            <span class="ml-2 text-sm text-gray-700">Dienst an Feiertagen</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" id="ferienCheck" class="form-checkbox h-5 w-5 text-blue-600" checked/>
            <span class="ml-2 text-sm text-gray-700">Dienst in Ferien</span>
          </label>
        </div>
      </div>

      <label class="block font-medium">Anzahl Terminreihen (max. 5):
        <select id="anzahl_reihen" class="w-full border border-blue-200 rounded-lg px-3 py-2 mt-1">
          <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option>
        </select>
      </label>

      <p id="global_date_hint" class="hint-msg"></p>
      <p id="ferien_hint" class="hint-msg hidden"></p>
    </div>

    <!-- Terminreihen -->
    <div id="terminreihen-container" class="space-y-8 mt-4"></div>

    <!-- Aktionen -->
    <div class="flex flex-wrap gap-4 justify-center pt-6 md:pt-5">
      <button id="btnBerechnen" class="bg-blue-600 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-blue-700">Termine ermitteln</button>
      <button id="btnReset" class="bg-red-600 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-red-700">Reset Termine</button>
    </div>

    <!-- Exporte -->
    <div id="exportButtons" class="flex flex-wrap gap-4 justify-center pt-8 md:pt-5 pb-8 md:pb-5">
      <button id="btnCsv"  class="bg-green-600 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-green-700 disabled-btn"  disabled>Export als CSV</button>
      <button id="btnPdf"  class="bg-yellow-500 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-yellow-600 disabled-btn" disabled>Export als PDF</button>
      <button id="btnIcs"  class="bg-purple-600 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-purple-700 disabled-btn" disabled>Export als ICS</button>
      <button id="btnXlsx" class="bg-indigo-600 text-white font-bold px-7 py-3 rounded-xl shadow hover:bg-indigo-700 disabled-btn" disabled>Export als Excel</button>
    </div>

    <!-- Ergebnis -->
    <div id="ergebnisDivider" class="hidden my-4"><div class="border-t border-gray-300"></div></div>
    <h2 id="ergebnisTitel" class="hidden text-lg font-extrabold text-blue-700" tabindex="-1">Ergebnistabelle</h2>

    <div class="mt-2 table-card">
      <!-- Toolbar jetzt initial versteckt -->
      <div class="table-toolbar hidden" id="tableToolbar">
        <div class="left">
          <input id="tableSearch" class="table-search" type="search" placeholder="Suchen… (Datum, Tag, Dienst, Hinweis)" aria-label="Tabelle durchsuchen">
          <button id="tableSearchClear" type="button" class="px-2 py-1 border rounded text-sm hover:bg-gray-50" title="Suche leeren">Reset Suche</button>
          <span id="tableCount" class="table-count"></span>
        </div>
        <div class="right"></div>
      </div>

      <!-- NEU: separater Scroll-Wrapper nur für Mobile -->
      <div class="table-scroll">
        <table class="min-w-full table-auto hidden" id="ergebnisTabelle">
          <thead>
            <tr class="bg-blue-100">
              <th class="border px-4 py-2 text-left">Datum</th>
              <th class="border px-4 py-2 text-left">Tag</th>
              <th class="border px-4 py-2 text-left">Dienst</th>
              <th class="border px-4 py-2 text-left">Uhrzeit</th>
              <th class="border px-4 py-2 text-left">Hinweis</th>
            </tr>
          </thead>
          <tbody id="tabelleBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Hinweise -->
    <div class="legend-box" role="note">
      <button id="toggleHinweise" class="w-full flex items-center justify-between gap-4" aria-expanded="false" aria-controls="hinweisePanel" type="button">
        <span class="text-sm font-semibold text-blue-700">Hinweise &amp; Legende anzeigen</span>
        <svg class="chevron" width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M5 8l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <div id="hinweisePanel" class="mt-2 collapsible">
        <div class="mt-1">
          <span class="auto-badge">⚡ auto</span> = Vorschlagswerte:
          <em>Zeit:</em> Mo–Fr <strong>19:00–22:30</strong>, Sa–So <strong>07:30–17:00</strong>.
          <em>Datum:</em> <strong>01.01.</strong> und <strong>31.12.</strong> des aktuellen Jahres.
        </div><br>
        <strong>Hinweise:</strong>
        <ul class="list-disc pl-5 mt-1 space-y-1">
          <li>Die Zeit-Defaults werden bei Auswahl des Wochentags ermittelt.</li>
          <li>Die Datum-Defaults (<strong>01.01.</strong> und <strong>31.12.</strong> des aktuellen Jahres) werden immer vorbelegt.</li>
          <li>Bei manueller Eingabe verschwindet das <span class="auto-badge">⚡ auto</span>-Badge.</li>
          <li><strong>Reset Termine</strong> setzt Eingaben auf Default und leert die Tabelle.</li>
          <li>Die Export-Buttons sind erst nach <strong>Termine ermitteln</strong> aktiv.</li>
          <li><em>Ferien-Logik:</em> Ist <strong>Dienst in Ferien</strong> deaktiviert, werden Termine mit <strong>Entfällt</strong> markiert; im Feld <strong>Hinweis</strong> steht der Ferienname; Beim ICS-Export ist der Termin dann zwar enthalten, aber <strong>abgesagt</strong>.</li>
          <li><em>Feiertag-Logik:</em> Ist <strong>Dienst an Feiertagen</strong> deaktiviert, werden Termine mit <strong>Entfällt</strong> markiert; Beim ICS-Export ist der Termin dann zwar enthalten, aber <strong>abgesagt</strong>.</li>
          <li><em>Gültiger Datumsbereich:</em> Aktuelles Jahr − 2 bis aktuelles Jahr + 4.</li>
          <li>Zur Ausführung der Anwendung ist eine Internetverbindung erforderlich.</li>
          <li><em>Datenquelle für Ferien und Feiertage: </em> <a href="https://www.openholidaysapi.org" target="_blank" rel="noopener">OpenHolidaysAPI.</a></li>
        </ul>
      </div>
    </div>

    <footer>
      © 2025 · Wolfgang Saal, Böllenborn · August 2025<br>
      MIT-Lizenz. Download: <a href="https://github.com/wsaal68/dienstorbit" target="_blank" rel="noopener">github.com/wsaal68/dienstorbit</a>.
    </footer>

  </div><!-- /max-w wrapper -->

  <!-- Floating Buttons -->
  <button id="btnToResults" type="button" class="float-btn to-results rounded-full bg-white text-blue-700 border border-blue-200 shadow-lg px-4 py-2" title="Zur Ergebnistabelle">Zur Tabelle</button>
  <button id="btnToExport"  type="button" class="float-btn to-export  rounded-full bg-white text-blue-700 border border-blue-200 shadow-lg px-4 py-2" title="Zu den Export-Buttons">Zum Export</button>
  <button id="btnToTop"     type="button" class="float-btn to-top     rounded-full bg-blue-600 text-white shadow-lg px-4 py-3" title="Nach oben">
    <svg width="22" height="22" viewBox="0 0 20 20" fill="none" aria-hidden="true"><path d="M10 4l6 6M10 4L4 10M10 4v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <script>
/* ========= Basics ========= */
const $ = sel => document.querySelector(sel);
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

/* ========= Brand-Logo ========= */
const BRAND_CANDIDATES = [
  'logo_dienstorbit.png','DienstOrbit Schriftzug schmal.png','DienstOrbit Schriftzug.png',
  'DienstOrbit Logo.png','logo.png','dienstorbit.png'
];
window.brandLogoDataUrl = null; let brandNatural = {w:0, h:0};
function tryLoadImage(src){ return new Promise(resolve=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=()=>resolve(null); img.src=src+(src.includes('?')?'&':'?')+'cb='+Date.now(); }); }
function blobToDataURL(blob){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(blob); }); }
async function srcToDataURL(src){
  try{ const res=await fetch(src,{cache:'no-store'}); if(res.ok){ const b=await res.blob(); const d=await blobToDataURL(b); if(typeof d==='string'&&d.startsWith('data:')) return d; } }catch(_){}
  return new Promise(resolve=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>{ try{ const c=document.createElement('canvas'); c.width=i.naturalWidth||i.width; c.height=i.naturalHeight||i.height; c.getContext('2d').drawImage(i,0,0); resolve(c.toDataURL('image/png')); }catch(e){ resolve(null);} }; i.onerror=()=>resolve(null); i.src=src+(src.includes('?')?'&':'?')+'cb='+Date.now(); });
}
async function setupBrand(){
  const imgEl=$('#brandLogo'), fallbackEl=$('#brandFallback');
  for(const cand of BRAND_CANDIDATES){
    const ok=await tryLoadImage(cand); if(!ok) continue;
    fallbackEl?.classList.add('hidden'); fallbackEl?.style.setProperty('display','none','important');
    imgEl.src=ok.src; imgEl.classList.remove('hidden');
    brandNatural={ w: ok.naturalWidth||ok.width, h: ok.naturalHeight||ok.height };
    window.brandLogoDataUrl=await srcToDataURL(ok.src);
    break;
  }
  if(!imgEl.src){ fallbackEl?.classList.remove('hidden'); }
}

/* ========= UI-Helfer ========= */
function getYearBounds(){ const y=new Date().getFullYear(); return { minYear:y-2, maxYear:y+4, minDateStr:`${y-2}-01-01`, maxDateStr:`${y+4}-12-31` }; }
function applyDateBounds(scope){ const {minDateStr,maxDateStr}=getYearBounds(); (scope||document).querySelectorAll('.dienst_start, .dienst_ende').forEach(inp=>{ inp.setAttribute('min',minDateStr); inp.setAttribute('max',maxDateStr); }); }
function updateGlobalHints(){
  const {minYear,maxYear}=getYearBounds(); const ferienOff=!$('#ferienCheck').checked;
  const base=`Gültiger Datumsbereich für Start-/Enddatum: 01.01.${minYear} bis 31.12.${maxYear}.`;
  const extra = ferienOff ? ' „Dienst in Ferien“ ist deaktiviert (also kein Dienst in den Ferien... z.B. bei den Jugend-Diensten) – Termine werden in der Ausgabetabelle als "Abgesagt" eingetragen. In der Spalte "Hinweise" werden die Ferien aufgeführt.' : ' „Dienst in Ferien“ ist aktiviert (also findet Dienst in den Ferien statt) – Termine werden in der Ausgabetabelle ohne weiteren Hinweis auf die Ferien aufgenommen.';
  $('#global_date_hint').textContent = base + extra;
}

/* ========= Terminreihen ========= */
function createTerminreihe(index){
  const y=new Date().getFullYear(); const {minDateStr,maxDateStr}=getYearBounds();
  return `
  <div class="border p-4 rounded-xl bg-blue-50 space-y-3 terminreihe">
    <h3 class="text-xl font-extrabold text-blue-700 uppercase">Terminreihe ${index}</h3>

    <label class="block font-medium">Bezeichnung:
      <input type="text" class="dienst_bezeichnung w-full border rounded px-3 py-2">
      <span class="error-msg">Bitte eine Bezeichnung eingeben.</span>
    </label>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <label class="block font-medium">Wochentag:
        <select class="dienst_wochentag w-full border rounded px-3 py-2">
          <option value="">Bitte wählen</option>
          <option>Montag</option><option>Dienstag</option><option>Mittwoch</option>
          <option>Donnerstag</option><option>Freitag</option><option>Samstag</option><option>Sonntag</option>
        </select>
        <span class="error-msg">Bitte einen Wochentag wählen.</span>
      </label>

      <label class="block font-medium">Turnus:
        <select class="dienst_turnus w-full border rounded px-3 py-2">
          <option value="woechentlich">Wöchentlich</option>
          <option value="2woechentlich">Zweiwöchentlich</option>
          <option value="monatlich">Monatlich</option>
        </select>
        <span class="error-msg">Bitte einen Turnus wählen.</span>
      </label>

      <label class="block font-medium monatlich-option hidden">Position im Monat:
        <select class="dienst_monat_position w-full border rounded px-3 py-2" disabled>
          <option value="1">Erster</option><option value="2">Zweiter</option>
          <option value="3">Dritter</option><option value="4">Vierter</option>
          <option value="-1">Letzter</option>
        </select>
        <span class="error-msg">Bitte die Position im Monat wählen.</span>
      </label>
    </div>

    <!-- ✨ NEU: field-grid sorgt für angenehmen Umbruch/Abstand auf Tablets -->
    <div class="grid field-grid grid-cols-1 md:grid-cols-2 gap-4">
      <label class="block font-medium">Startdatum:
        <input type="date" class="dienst_start w-full border rounded px-3 py-2" value="${y}-01-01" min="${minDateStr}" max="${maxDateStr}">
        <span class="error-msg">Bitte ein Startdatum wählen.</span>
      </label>
      <label class="block font-medium">Enddatum:
        <input type="date" class="dienst_ende w-full border rounded px-3 py-2" value="${y}-12-31" min="${minDateStr}" max="${maxDateStr}">
        <span class="error-msg">Bitte ein Enddatum wählen.</span>
      </label>
    </div>

    <!-- ✨ NEU: field-grid auch für Zeiten -->
    <div class="grid field-grid grid-cols-1 md:grid-cols-2 gap-4">
      <label class="block font-medium">Startzeit:
        <input type="time" class="dienst_startzeit w-full border rounded px-3 py-2">
        <span class="error-msg">Bitte eine Startzeit angeben.</span>
      </label>
      <label class="block font-medium">Endzeit:
        <input type="time" class="dienst_endzeit w-full border rounded px-3 py-2">
        <span class="error-msg">Bitte eine Endzeit angeben.</span>
      </label>
    </div>
  </div>`;
}

function safeParseInt(v,def){ const n=parseInt(v,10); return Number.isFinite(n)?n:def; }
function updateTerminreihen(opts={}){
  const container=$('#terminreihen-container'); const fresh=!!opts.fresh;
  const snapshot = fresh? [] : Array.from(container.querySelectorAll('.terminreihe')).map(reihe=>{
    const q=s=>reihe.querySelector(s), v=s=>q(s)?.value || '';
    return {
      bezeichnung:v('.dienst_bezeichnung'), wochentag:v('.dienst_wochentag'), turnus:v('.dienst_turnus')||'woechentlich',
      monatPos:v('.dienst_monat_position'), start:v('.dienst_start'), ende:v('.dienst_ende'),
      startzeit:v('.dienst_startzeit'), endzeit:v('.dienst_endzeit'),
      startzeitManual:q('.dienst_startzeit')?.dataset.manual==='1', endzeitManual:q('.dienst_endzeit')?.dataset.manual==='1',
      startDateManual:q('.dienst_start')?.dataset.manual==='1', endDateManual:q('.dienst_ende')?.dataset.manual==='1'
    };
  });
  container.innerHTML=''; const count=Math.min(Math.max(safeParseInt($('#anzahl_reihen')?.value,1),1),5);
  for(let i=1;i<=count;i++) container.insertAdjacentHTML('beforeend', createTerminreihe(i));

  const neu=Array.from(container.querySelectorAll('.terminreihe'));
  neu.forEach((r,i)=>{
    const d=snapshot[i]; if(!d) return;
    const set=(sel,val)=>{ const el=r.querySelector(sel); if(el && val!=='') el.value=val; };
    set('.dienst_bezeichnung', d.bezeichnung); set('.dienst_wochentag', d.wochentag); set('.dienst_turnus', d.turnus);
    const monatDiv=r.querySelector('.monatlich-option'); const selMon=monatDiv?.querySelector('select');
    if(d.turnus==='monatlich'){ monatDiv?.classList.remove('hidden'); selMon?.removeAttribute('disabled'); }
    set('.dienst_monat_position', d.monatPos);
    const sDate=r.querySelector('.dienst_start'), eDate=r.querySelector('.dienst_ende');
    if(sDate){ if(d.start) sDate.value=d.start; if(d.startDateManual) sDate.dataset.manual='1'; }
    if(eDate){ if(d.ende) eDate.value=d.ende; if(d.endDateManual) eDate.dataset.manual='1'; }
    const st=r.querySelector('.dienst_startzeit'), en=r.querySelector('.dienst_endzeit');
    if(st){ if(d.startzeit) st.value=d.startzeit; if(d.startzeitManual) st.dataset.manual='1'; }
    if(en){ if(d.endzeit) en.value=d.endzeit; if(d.endzeitManual) en.dataset.manual='1'; }
  });

  applyDateBounds(container); updateGlobalHints();

  container.querySelectorAll('.dienst_turnus').forEach(select=>{
    select.addEventListener('change', e=>{
      const wrap=e.target.closest('.terminreihe'); const monatDiv=wrap.querySelector('.monatlich-option'); const selMon=monatDiv.querySelector('select');
      if(e.target.value==='monatlich'){ monatDiv.classList.remove('hidden'); selMon.removeAttribute('disabled'); }
      else { monatDiv.classList.add('hidden'); selMon.setAttribute('disabled','disabled'); }
    });
  });
}

/* ========= Auto-Badges ========= */
function setAutoBadgeFor(input,on){
  if(!input) return; const label=input.closest('label'); if(!label) return;
  let badge=label.querySelector('.auto-badge');
  if(on){ if(!badge){ badge=document.createElement('span'); badge.className='auto-badge'; badge.textContent='⚡ auto'; label.appendChild(badge);} input.classList.add('bg-yellow-100'); }
  else { if(badge) badge.remove(); input.classList.remove('bg-yellow-100'); }
}
function applyAutoBadgesForDates(scope){
  (scope||document).querySelectorAll('.terminreihe').forEach(r=>{
    const s=r.querySelector('.dienst_start'), e=r.querySelector('.dienst_ende');
    [s,e].forEach(inp=>{
      if(!inp || inp.dataset.manual==='1') return;
      const v=inp.value||'', isDefault = v.slice(5)==='01-01' || v.slice(5)==='12-31';
      if(isDefault){ inp.dataset.auto='1'; setAutoBadgeFor(inp,true); } else { delete inp.dataset.auto; setAutoBadgeFor(inp,false); }
    });
  });
}
function applyAutoBadgesForTimes(scope){
  (scope||document).querySelectorAll('.terminreihe').forEach(reihe=>{
    const w=reihe.querySelector('.dienst_wochentag')?.value||'';
    const st=reihe.querySelector('.dienst_startzeit'); const en=reihe.querySelector('.dienst_endzeit');
    if(!st||!en||st.dataset.manual==='1'||en.dataset.manual==='1') return;
    const werktage=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag'];
    if(!w){ st.value=''; en.value=''; setAutoBadgeFor(st,false); setAutoBadgeFor(en,false); return; }
    if(w==='Samstag'||w==='Sonntag'){ st.value='07:30'; en.value='17:00'; }
    else if(werktage.includes(w)){ st.value='19:00'; en.value='22:30'; }
    setAutoBadgeFor(st,true); setAutoBadgeFor(en,true);
  });
}

/* ========= Validierung ========= */
function getOrCreateErrorEl(input){
  const label=input.closest('label')||input.parentElement||input;
  let p=label.querySelector('.error-msg'); if(!p){ p=document.createElement('p'); p.className='error-msg'; label.appendChild(p); }
  return p;
}
function setFieldError(input,msg){
  input?.classList.add('error-field'); input?.setAttribute('aria-invalid','true');
  const p=getOrCreateErrorEl(input); p.textContent=msg||'Pflichtfeld'; p.style.display='block';
}
function clearFieldError(input){
  input?.classList.remove('error-field'); input?.removeAttribute('aria-invalid');
  const p=input?.closest('label')?.querySelector('.error-msg'); if(p){ p.style.display='none'; p.textContent=''; }
}
function validateTerminreihe(reihe){
  let valid=true;
  const bezeichnung=reihe.querySelector('.dienst_bezeichnung');
  const wochentag=reihe.querySelector('.dienst_wochentag');
  const turnus=reihe.querySelector('.dienst_turnus');
  const monatPos=reihe.querySelector('.dienst_monat_position');
  const monatWrap=reihe.querySelector('.monatlich-option');
  const start=reihe.querySelector('.dienst_start');
  const ende =reihe.querySelector('.dienst_ende');
  const st=reihe.querySelector('.dienst_startzeit');
  const en=reihe.querySelector('.dienst_endzeit');
  const {minYear,maxYear}=getYearBounds();

  if(!bezeichnung.value.trim()){ setFieldError(bezeichnung,'Bitte eine Bezeichnung eingeben.'); valid=false; } else clearFieldError(bezeichnung);
  if(!wochentag.value){ setFieldError(wochentag,'Bitte einen Wochentag wählen.'); valid=false; } else clearFieldError(wochentag);
  if(!turnus.value){ setFieldError(turnus,'Bitte einen Turnus wählen.'); valid=false; } else clearFieldError(turnus);

  if(turnus.value==='monatlich'){
    monatWrap?.classList.remove('hidden'); monatPos?.removeAttribute('disabled');
    if(!monatPos.value){ setFieldError(monatPos,'Bitte die Position im Monat wählen.'); valid=false; } else clearFieldError(monatPos);
  } else { monatWrap?.classList.add('hidden'); monatPos?.setAttribute('disabled','disabled'); clearFieldError(monatPos); }

  if(!start.value){ setFieldError(start,'Bitte ein Startdatum wählen.'); valid=false; }
  else { const y=new Date(start.value).getFullYear(); if(y<minYear||y>maxYear){ setFieldError(start,`Erlaubter Zeitraum: ${minYear}–${maxYear}.`); valid=false; } else clearFieldError(start); }

  if(!ende.value){ setFieldError(ende,'Bitte ein Enddatum wählen.'); valid=false; }
  else { const y2=new Date(ende.value).getFullYear(); if(y2<minYear||y2>maxYear){ setFieldError(ende,`Erlaubter Zeitraum: ${minYear}–${maxYear}.`); valid=false; } else clearFieldError(ende); }

  if(start.value && ende.value){
    const sd=new Date(start.value), ed=new Date(ende.value);
    if(sd>ed){ setFieldError(ende,'Enddatum liegt vor Startdatum.'); valid=false; } else clearFieldError(ende);
  }

  if(!st.value){ setFieldError(st,'Bitte eine Startzeit angeben.'); valid=false; } else clearFieldError(st);
  if(!en.value){ setFieldError(en,'Bitte eine Endzeit angeben.'); valid=false; } else clearFieldError(en);
  if(st.value && en.value && st.value >= en.value){ setFieldError(en,'Endzeit muss nach Startzeit liegen.'); valid=false; } else clearFieldError(en);

  return valid;
}
function validateGeneralFields(){
  let valid=true;
  const ov=$('#ov_name'); const bl=$('#bundesland');
  if(!ov.value.trim()){ setFieldError(ov,'Bitte geben Sie den Namen des Ortsverbands ein.'); valid=false; } else clearFieldError(ov);
  if(!bl.value){ setFieldError(bl,'Bitte Bundesland wählen.'); valid=false; } else clearFieldError(bl);
  return valid;
}

function updateFerienHint(){
  const ferienHint=$('#ferien_hint'), ferienCheck=$('#ferienCheck'); if(!ferienHint||!ferienCheck) return;
  ferienHint.classList.toggle('hidden', ferienCheck.checked);
}

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await setupBrand();

  // gespeicherte Werte
  try{
    const sOV=localStorage.getItem('ov_name'); if(sOV!==null) $('#ov_name').value=sOV;
    const sBL=localStorage.getItem('bundesland'); if(sBL!==null) $('#bundesland').value=sBL;
    const sFT=localStorage.getItem('feiertagsCheck'); if(sFT!==null) $('#feiertagsCheck').checked=(sFT==='1');
    const sFerien=localStorage.getItem('ferienCheck'); if(sFerien!==null) $('#ferienCheck').checked=(sFerien==='1');
  }catch{}

  updateTerminreihen(); applyDateBounds(); updateGlobalHints(); applyAutoBadgesForDates(); applyAutoBadgesForTimes();
  setupCollapsible(); updateFerienHint();

  // Toolbar initial sicher ausblenden
  updateToolbarVisibility();

  // Fehler sofort entfernen (Allgemeine Angaben)
  $('#ov_name').addEventListener('input', e=>{ localStorage.setItem('ov_name', e.target.value); if(e.target.value.trim()) clearFieldError(e.target); });
  $('#bundesland').addEventListener('change', e=>{ localStorage.setItem('bundesland', e.target.value); if(e.target.value) clearFieldError(e.target); });
  $('#feiertagsCheck').addEventListener('change', e=>{ localStorage.setItem('feiertagsCheck', e.target.checked?'1':'0'); });
  $('#ferienCheck').addEventListener('change', e=>{ localStorage.setItem('ferienCheck', e.target.checked?'1':'0'); updateGlobalHints(); updateFerienHint(); });

  $('#anzahl_reihen').addEventListener('change', ()=>{ updateTerminreihen(); applyDateBounds(); applyAutoBadgesForDates(); applyAutoBadgesForTimes(); });
  
  // Inputs beobachten (Terminreihen)
  $('#terminreihen-container').addEventListener('input', e=>{
    const reihe=e.target.closest('.terminreihe'); if(!reihe) return;
    if(e.target.matches('.dienst_startzeit, .dienst_endzeit, .dienst_start, .dienst_ende')){ e.target.dataset.manual='1'; setAutoBadgeFor(e.target,false); }
    if(e.target.matches('.dienst_bezeichnung, .dienst_startzeit, .dienst_endzeit, .dienst_start, .dienst_ende')) validateTerminreihe(reihe);
  });
  $('#terminreihen-container').addEventListener('change', e=>{
    const r=e.target.closest('.terminreihe'); if(!r) return;
    if(e.target.classList.contains('dienst_wochentag')){
      const val=e.target.value, werktage=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag'];
      const st=r.querySelector('.dienst_startzeit'), en=r.querySelector('.dienst_endzeit');
      const ms=st?.dataset.manual==='1', me=en?.dataset.manual==='1';
      if(val===''){ if(st&&!ms){st.value='';setAutoBadgeFor(st,false);} if(en&&!me){en.value='';setAutoBadgeFor(en,false);} }
      else if(val==='Samstag'||val==='Sonntag'){ if(st&&!ms){st.value='07:30';setAutoBadgeFor(st,true);} if(en&&!me){en.value='17:00';setAutoBadgeFor(en,true);} }
      else if(werktage.includes(val)){ if(st&&!ms){st.value='19:00';setAutoBadgeFor(st,true);} if(en&&!me){en.value='22:30';setAutoBadgeFor(en,true);} }
    }
    if(e.target.matches('.dienst_turnus, .dienst_monat_position, .dienst_wochentag, .dienst_start, .dienst_ende')) validateTerminreihe(r);
  });

  // Floating Buttons
  updateToTopVisibility(); updateResultsButtonVisibility(); updateExportButtonVisibility();
});

/* ========= Collapsible ========= */
function setupCollapsible(){
  const btn=$('#toggleHinweise'), panel=$('#hinweisePanel'), chev=btn?.querySelector('.chevron'); if(!btn||!panel) return;
  function setOpen(open){
    btn.setAttribute('aria-expanded', String(open)); chev?.setAttribute('aria-expanded', String(open));
    btn.querySelector('span').textContent = open ? 'Hinweise & Legende verbergen' : 'Hinweise & Legende anzeigen';
    if (prefersReduced){ panel.classList.toggle('open', open); panel.style.maxHeight=open?'none':'0px'; panel.style.opacity=open?'1':'0'; }
    else {
      if(open){ panel.classList.add('open'); panel.style.maxHeight='0px'; panel.style.opacity='0'; requestAnimationFrame(()=>{ const h=panel.scrollHeight; panel.style.maxHeight=h+'px'; panel.style.opacity='1'; }); }
      else { const h=panel.scrollHeight; panel.style.maxHeight=h+'px'; panel.style.opacity='1'; requestAnimationFrame(()=>{ panel.style.maxHeight='0px'; panel.style.opacity='0'; panel.addEventListener('transitionend', function handler(){ panel.classList.remove('open'); panel.removeEventListener('transitionend', handler); }); }); }
    }
    localStorage.setItem('hinweiseOpen', open?'1':'0');
  }
  setOpen(localStorage.getItem('hinweiseOpen') === '1');
  btn.addEventListener('click', ()=> setOpen(!(btn.getAttribute('aria-expanded')==='true')));
}

/* ========= Ergebnis-Berechnung ========= */
function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function ymdToLocalDate(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,(m||1)-1,d||1); }

function validateInputs(){
  let valid=true;
  if(!validateGeneralFields()) valid=false;
  document.querySelectorAll('#terminreihen-container > .terminreihe').forEach(reihe=>{ if(!validateTerminreihe(reihe)) valid=false; });
  return valid;
}
function toggleExportButtons(enable){ ['btnCsv','btnPdf','btnIcs','btnXlsx'].forEach(id=>{ const b=$('#'+id); b.disabled=!enable; b.classList.toggle('disabled-btn', !enable); }); }
toggleExportButtons(false);

/* === Toolbar (Sichtbarkeit + Suchen / Leeren / Zähler) === */
function updateToolbarVisibility(){
  const bar = $('#tableToolbar') || $('.table-toolbar');
  const visible = hasResultsVisible();
  if(bar){
    bar.classList.toggle('hidden', !visible);
  }
}
function ensureTableToolbar(){
  const card=document.querySelector('.table-card'); if(!card) return;
  let bar=card.querySelector('.table-toolbar');
  if(!bar){
    bar=document.createElement('div');
    bar.className='table-toolbar hidden';
    bar.id='tableToolbar';
    bar.innerHTML=`
      <div class="left">
        <input id="tableSearch" class="table-search" type="search" placeholder="Suchen… (Datum, Tag, Dienst, Hinweis)" aria-label="Tabelle durchsuchen">
        <button id="tableSearchClear" type="button" class="px-2 py-1 border rounded text-sm hover:bg-gray-50" title="Suche leeren">Leeren</button>
        <span id="tableCount" class="table-count"></span>
      </div>
      <div class="right"></div>
    `;
    card.insertBefore(bar, card.firstChild);
  } else {
    // sicherstellen, dass nötige Elemente existieren
    if(!bar.querySelector('#tableSearch')) {
      const left=bar.querySelector('.left') || bar.appendChild(document.createElement('div'));
      left.className='left';
      left.insertAdjacentHTML('afterbegin', `<input id="tableSearch" class="table-search" type="search" placeholder="Suchen… (Datum, Tag, Dienst, Hinweis)" aria-label="Tabelle durchsuchen">`);
    }
    if(!bar.querySelector('#tableSearchClear')){
      const btn=document.createElement('button');
      btn.id='tableSearchClear'; btn.type='button';
      btn.className='px-2 py-1 border rounded text-sm hover:bg-gray-50';
      btn.title='Suche leeren'; btn.textContent='Leeren';
      bar.querySelector('.left')?.appendChild(btn);
    }
    if(!bar.querySelector('#tableCount')){
      const span=document.createElement('span'); span.id='tableCount'; span.className='table-count';
      bar.querySelector('.left')?.appendChild(span);
    }
  }
}

/* === Suche & Sortierung === */
let tableSortState = { col: null, dir: 'asc' };

function parseDateCell(s){
  const m=String(s).trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(!m) return 0;
  const d=new Date(Number(m[3]), Number(m[2])-1, Number(m[1])); return d.getTime()||0;
}
const wdayIndex={ 'Sonntag':0,'Montag':1,'Dienstag':2,'Mittwoch':3,'Donnerstag':4,'Freitag':5,'Samstag':6 };

function cellKey(tr,col){
  const td=tr.cells[col]; if(!td) return '';
  const txt=td.innerText.trim();
  if(col===0) return parseDateCell(txt);
  if(col===1) return wdayIndex[txt] ?? 9;
  if(col===3){ const m=txt.match(/(\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})/); if(!m) return 0; return Number(m[1])*6000+Number(m[2])*100+Number(m[3])*10+Number(m[4]); }
  return txt.replace(/^Entfällt:\s*/i,'').toLowerCase();
}
function sortTableBy(col){
  const table=$('#ergebnisTabelle'); const tbody=$('#tabelleBody'); if(!table||!tbody) return;
  const rows=Array.from(tbody.rows);
  if(tableSortState.col===col){ tableSortState.dir=(tableSortState.dir==='asc')?'desc':'asc'; }
  else { tableSortState.col=col; tableSortState.dir='asc'; }
  rows.sort((a,b)=>{ const ka=cellKey(a,col), kb=cellKey(b,col); if(ka<kb) return tableSortState.dir==='asc'?-1:1; if(ka>kb) return tableSortState.dir==='asc'?1:-1; return 0; });
  rows.forEach(r=>tbody.appendChild(r));
  table.querySelectorAll('thead th').forEach((th,i)=>{ th.classList.remove('sorted-asc','sorted-desc'); if(i===col) th.classList.add(tableSortState.dir==='asc'?'sorted-asc':'sorted-desc'); });
}
function attachTableSorting(){
  const thead=$('#ergebnisTabelle thead'); if(!thead) return;
  thead.querySelectorAll('th').forEach((th,idx)=>{
    if(!th.classList.contains('sortable')){
      th.classList.add('sortable'); const ind=document.createElement('span'); ind.className='sort-ind'; ind.setAttribute('aria-hidden','true'); ind.textContent='▾';
      th.style.position='relative'; th.appendChild(ind); th.tabIndex=0; th.title='Klicken zum Sortieren';
      th.addEventListener('click', ()=>sortTableBy(idx));
      th.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sortTableBy(idx);} });
    }
  });
}
function applySearchFilter(q){
  const tbody=$('#tabelleBody'); if(!tbody) return;
  const query=String(q||'').toLowerCase().trim(); let visible=0, total=0;
  Array.from(tbody.rows).forEach(tr=>{ total++; const text=tr.innerText.toLowerCase(); const match=!query||text.includes(query); tr.classList.toggle('row-hidden', !match); if(match) visible++; });
  const countEl=$('#tableCount'); if(countEl) countEl.textContent = visible===total ? `${total} Einträge` : `${visible} / ${total} Einträge`;
  let nr=$('#noResultsRow'); const card=$('.table-card')||$('#ergebnisTabelle')?.parentElement;
  if(!nr && card){ nr=document.createElement('div'); nr.id='noResultsRow'; nr.className='no-results'; nr.style.display='none'; nr.textContent='Keine Treffer.'; card.appendChild(nr); }
  if(nr) nr.style.display=(visible===0)?'':'none';
}
function attachSearch(){
  ensureTableToolbar();
  const input=$('#tableSearch'); const clearBtn=$('#tableSearchClear');
  if(input){ input.value=''; input.addEventListener('input', ()=>applySearchFilter(input.value)); }
  if(clearBtn && input){ clearBtn.addEventListener('click', ()=>{ input.value=''; applySearchFilter(''); input.focus(); }); }
}
function attachTableFeatures(){
  attachSearch();
  attachTableSorting();
  // Standardsortierung: Datum ASC
  tableSortState = { col: null, dir: 'asc' };
  sortTableBy(0); // ASC
  applySearchFilter('');
}

/* === Reset Termine === */
function clearAllFieldErrors(){
  document.querySelectorAll('.error-field').forEach(el=>{
    el.classList.remove('error-field'); el.removeAttribute('aria-invalid');
  });
  document.querySelectorAll('.error-msg').forEach(p=>{
    p.style.display='none'; p.textContent='';
  });
}

function resetTermine(){
  // Terminreihen neu aufsetzen (Defaults) – Anzahl beibehalten
  updateTerminreihen({ fresh: true });
  applyDateBounds();
  applyAutoBadgesForDates();
  applyAutoBadgesForTimes();
  updateGlobalHints();

  // Ergebnisse leeren & ausblenden
  const tbody = document.getElementById('tabelleBody');
  if (tbody) tbody.innerHTML = '';
  document.getElementById('ergebnisTabelle')?.classList.add('hidden');
  document.getElementById('ergebnisTitel')?.classList.add('hidden');
  document.getElementById('ergebnisDivider')?.classList.add('hidden');

  // Suchfeld leeren, Zähler zurücksetzen, Toolbar ausblenden
  const search = document.getElementById('tableSearch');
  if (search) search.value = '';
  try { applySearchFilter(''); } catch(_) {}
  updateToolbarVisibility?.();

  // Exporte deaktivieren, Floating-Buttons aktualisieren
  toggleExportButtons(false);
  updateResultsButtonVisibility?.();
  updateExportButtonVisibility?.();

  // Fehlermarkierungen entfernen
  clearAllFieldErrors();
}

// Click-Handler registrieren
document.getElementById('btnReset').addEventListener('click', resetTermine);
    
    
/* ========= Export-Helfer ========= */
function getCleanHeaderTexts(table){
  const ths = table?.querySelectorAll('thead th') || [];
  return [...ths].map(th=>{
    const clone = th.cloneNode(true);
    clone.querySelectorAll('.sort-ind').forEach(el=>el.remove());
    return (clone.textContent||'').replace(/[▾▴▼▲]/g,'').trim();
  });
}
function readRowExportValues(tr){
  const tds = tr.querySelectorAll('td');
  const dateDisplay = tds[0]?.innerText.trim() || '';
  const weekday     = tds[1]?.innerText.trim() || '';
  const dienstRaw   = tr.dataset.dienstRaw || (tds[2]?.innerText.trim() || '');
  const timeStart   = tr.dataset.timeStart || (tds[3]?.innerText.split(' - ')[0]?.trim() || '');
  const timeEnd     = tr.dataset.timeEnd   || (tds[3]?.innerText.split(' - ')[1]?.trim() || '');
  const hint        = tr.dataset.hint || '';
  return { dateDisplay, weekday, dienstRaw, timeStart, timeEnd, hint };
}
function displayTimeRange(s,e){ return (s&&e) ? `${s} - ${e}` : ''; }

/* ========= Export: CSV ========= */
function csvLine(arr,sep){ return arr.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(sep); }
function sanitizeFileName(name){ return (name||'OV').normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^a-z0-9_-]+/gi,'_').replace(/^_+|_+$/g,'')||'OV'; }
function getPlanYearsFromTable(){
  const cells=document.querySelectorAll('#tabelleBody tr td:first-child'); const years=new Set();
  cells.forEach(td=>{ const p=(td.innerText||'').split('.'); const y=p[2]; if(y) years.add(y); });
  if(!years.size) return ''; const arr=[...years].map(n=>parseInt(n,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
  return arr.length===1? String(arr[0]) : `${arr[0]}-${arr[arr.length-1]}`;
}
function buildBaseFileName(){ const ov=sanitizeFileName($('#ov_name')?.value||'OV'); const years=getPlanYearsFromTable()||String(new Date().getFullYear()); return `dienstplan_${ov}_${years}`; }

function exportCsv(){
  const table=$('#ergebnisTabelle'), tbody=$('#tabelleBody'); if(!tbody||!tbody.rows.length) return;
  const ovName=$('#ov_name').value || 'Unbekannter Ortsverband';
  const SEP=';', EOL='\r\n';
  const lines=['sep='+SEP, csvLine(['Ortsverband:', ovName], SEP)];
  const header=getCleanHeaderTexts(table); if(header.length) lines.push(csvLine(header, SEP));

  [...tbody.rows].forEach(tr=>{
    const r=readRowExportValues(tr);
    const row=[r.dateDisplay, r.weekday, r.dienstRaw, displayTimeRange(r.timeStart,r.timeEnd), r.hint];
    lines.push(csvLine(row, SEP));
  });

  const blob=new Blob(['\ufeff'+lines.join(EOL)], {type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=buildBaseFileName()+'.csv'; a.click();
}

/* ========= Export: ICS ========= */
function icsEscape(s){ if(!s) return ''; return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/;/g,'\\;').replace(/,/g,'\\,'); }
function foldICSLines(lines){ const out=[]; for(const line of lines){ const max=75; if(line.length<=max){ out.push(line); continue; } let i=0; while(i<line.length){ const chunk=line.slice(i,i+max); out.push((i===0?'':' ')+chunk); i+=max; } } return out; }
function exportIcs(){
  const rows=document.querySelectorAll('#tabelleBody tr'); if(!rows.length) return;
  const ovName=$('#ov_name').value || 'Unbekannter Ortsverband';
  const vtimezone=['BEGIN:VTIMEZONE','TZID:Europe/Berlin','X-LIC-LOCATION:Europe/Berlin','BEGIN:DAYLIGHT','TZOFFSETFROM:+0100','TZOFFSETTO:+0200','TZNAME:CEST','DTSTART:19700329T020000','RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU','END:DAYLIGHT','BEGIN:STANDARD','TZOFFSETFROM:+0200','TZOFFSETTO:+0100','TZNAME:CET','DTSTART:19701025T030000','RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU','END:STANDARD','END:VTIMEZONE'].join('\r\n');
  const cal=['BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','METHOD:PUBLISH','PRODID:-//DienstOrbit//DE', vtimezone];

  rows.forEach(tr=>{
    const r=readRowExportValues(tr);
    const [tag,monat,jahr]=(r.dateDisplay||'').split('.');
    if(!jahr||!r.timeStart||!r.timeEnd) return;
    const start=`${jahr}${monat}${tag}T${r.timeStart.replace(':','')}00`;
    const end  =`${jahr}${monat}${tag}T${r.timeEnd.replace(':','')}00`;
    const uid=`${jahr}${monat}${tag}-${Math.random().toString(36).slice(2)}@dienstorbit`;
    const dtstamp=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';

    const ve=['BEGIN:VEVENT',`UID:${uid}`,`DTSTAMP:${dtstamp}`,`SUMMARY:${icsEscape(r.dienstRaw)}`,`LOCATION:${icsEscape(ovName)}`,`DTSTART;TZID=Europe/Berlin:${start}`,`DTEND;TZID=Europe/Berlin:${end}`];

    if(/^Entfällt:\s*/i.test(r.dienstRaw)){
      ve.push('STATUS:CANCELLED');
      if(r.hint) ve.push(`DESCRIPTION:${icsEscape('Termin fällt aus wegen: '+r.hint)}`);
    } else if(r.hint){
      ve.push(`DESCRIPTION:${icsEscape('Hinweis: '+r.hint)}`);
    }
    ve.push('END:VEVENT'); cal.push(...foldICSLines(ve));
  });

  cal.push('END:VCALENDAR');
  const blob=new Blob([cal.join('\r\n')], {type:'text/calendar;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=buildBaseFileName()+'.ics'; a.click();
}

/* ========= Export: PDF ========= */
function exportPdf(){
  const ovName=$('#ov_name').value || 'Unbekannter Ortsverband';
  const table=$('#ergebnisTabelle'); const rows=document.querySelectorAll('#tabelleBody tr'); if(!rows.length||!table) return;

  const years=getPlanYearsFromTable() || new Date().getFullYear().toString();
  const head=getCleanHeaderTexts(table);

  const body=[...rows].map(tr=>{
    const r=readRowExportValues(tr);
    return [r.dateDisplay, r.weekday, r.dienstRaw, displayTimeRange(r.timeStart, r.timeEnd), r.hint];
  });

  function loadJsPDF(){
    return new Promise(async resolve=>{
      if(window.jspdf?.jsPDF && window.jspdf.jsPDF.API?.autoTable) return resolve(true);
      const js=['https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js','https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'];
      const at=['https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js','https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js'];
      const tryLoad=src=>new Promise(res=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; const t=setTimeout(()=>res(false),7000); s.onload=()=>{clearTimeout(t); res(true)}; s.onerror=()=>{clearTimeout(t); res(false)}; document.head.appendChild(s); });
      let ok=false; for(const u of js){ ok=await tryLoad(u); if(ok) break; } if(!ok) return resolve(false);
      ok=false; for(const u of at){ ok=await tryLoad(u); if(ok) break; } resolve(ok);
    });
  }

  (async ()=>{
    const loaded=await loadJsPDF(); if(!loaded||!window.jspdf?.jsPDF){ alert('Konnte jsPDF nicht laden.'); return; }
    const { jsPDF }=window.jspdf; const doc=new jsPDF({ unit:'pt', format:'a4' });
    const pageWidth=doc.internal.pageSize.getWidth(); const pageHeight=doc.internal.pageSize.getHeight();

    const headStyles={ fillColor:[239,246,255], textColor:[30,58,138], lineColor:[229,231,235], lineWidth:0.8, halign:'left', fontSize:9 };
    const bodyStyles={ lineColor:[229,231,235], lineWidth:.4, textColor:[22,22,22], fontSize:9, cellPadding:4 };
    const altRowStyles={ fillColor:[249,250,251] };
    const columnStyles={ 0:{ cellWidth:90 }, 1:{ cellWidth:70 }, 2:{ cellWidth:'auto' }, 3:{ cellWidth:78 }, 4:{ cellWidth:160 } };

    const haveLogo = !!window.brandLogoDataUrl;
    const headerBandH = haveLogo ? 60 : 40;
    const startYTable = headerBandH + 10;

    doc.autoTable({
      head:[head], body,
      startY:startYTable,
      margin:{ left:40, right:40, top:startYTable, bottom:58 },
      styles:bodyStyles, headStyles, alternateRowStyles:altRowStyles, columnStyles,
      didParseCell:(data)=>{
        if(data.section==='body'){
          const dienst=data.row.raw?.[2] || '';
          const hint  =data.row.raw?.[4] || '';
          if(hint){ data.cell.styles.fillColor=[255,247,237]; data.cell.styles.textColor=[0,0,0]; }
          if(/^Entfällt:\s*/i.test(dienst)){ data.cell.styles.textColor=[220,38,38]; if(!hint) data.cell.styles.fillColor=[254,242,242]; }
        }
      }
    });

    const pageCount=doc.internal.getNumberOfPages();
    for(let i=1;i<=pageCount;i++){
      doc.setPage(i);
      doc.setFillColor(245,249,255); doc.rect(0,0,pageWidth,headerBandH,'F');
      doc.setDrawColor(229,231,235); doc.setLineWidth(0.8); doc.line(40, headerBandH-2, pageWidth-40, headerBandH-2);

      if(haveLogo){
        const ratio=(brandNatural.w>0 && brandNatural.h>0)?(brandNatural.w/brandNatural.h):4;
        const maxH=38, maxW=pageWidth*0.42; let drawH=maxH, drawW=Math.min(maxW, drawH*ratio);
        if(drawW>maxW){ drawW=maxW; drawH=drawW/ratio; }
        try{ doc.addImage(window.brandLogoDataUrl,'PNG',40,18,drawW,drawH,undefined,'FAST'); }catch(_){}
      } else { doc.setFont('helvetica','bold'); doc.setTextColor(30,58,138); doc.setFontSize(14); doc.text('DienstOrbit',40,30,{align:'left'}); }

      // Header rechts
      doc.setTextColor(30,58,138);
      doc.setFontSize(11);
      const prefix   = 'Dienstplan für ';
      const boldPart = [ovName, years].filter(Boolean).join(' • ');

      doc.setFont('helvetica','normal');
      const prefixW = doc.getTextWidth(prefix);

      doc.setFont('helvetica','bold');
      const boldW   = doc.getTextWidth(boldPart);

      const totalW  = prefixW + boldW;
      const xRight  = pageWidth - 40;
      const yHeader = 32;
      const xStart  = xRight - totalW;

      doc.setFont('helvetica','normal'); doc.text(prefix, xStart, yHeader);
      doc.setFont('helvetica','bold');   doc.text(boldPart, xStart + prefixW, yHeader);

      const yBase=pageHeight-26;
      doc.setDrawColor(229,231,235); doc.setLineWidth(0.8); doc.line(40, yBase-16, pageWidth-40, yBase-16);
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(100);
      doc.text(`Erstellt am ${new Date().toLocaleString('de-DE')}`, 40, yBase);
      doc.text('© 2025 DienstOrbit – Wolfgang Saal', pageWidth/2, yBase, { align:'center' });
      doc.text(`Seite ${i} / ${pageCount}`, pageWidth-40, yBase, { align:'right' });
    }
    doc.save(`${buildBaseFileName()}.pdf`);
  })();
}

/* ========= Export: Excel ========= */
async function exportXlsx(){
  const tbody=$('#tabelleBody'); if(!tbody||!tbody.rows.length) return;

  async function loadSheetJS(){
    if(typeof window.XLSX!=='undefined') return true;
    const srcs=['https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js','https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js','https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js'];
    const tryLoad=src=>new Promise(res=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; const t=setTimeout(()=>res(false),7000); s.onload=()=>{clearTimeout(t); res(typeof window.XLSX!=='undefined')}; s.onerror=()=>{clearTimeout(t); res(false)}; document.head.appendChild(s); });
    for(const u of srcs){ if(await tryLoad(u)) return true; } return false;
  }
  const loaded=await loadSheetJS(); if(!loaded){ alert('Konnte SheetJS nicht laden.'); return; }

  try{
    const XLSX=window.XLSX, wb=XLSX.utils.book_new();
    const header=getCleanHeaderTexts($('#ergebnisTabelle'));
    const data=[ ...tbody.rows ].map(tr=>{
      const r=readRowExportValues(tr);
      return [r.dateDisplay, r.weekday, r.dienstRaw, displayTimeRange(r.timeStart,r.timeEnd), r.hint];
    });
    const ws=XLSX.utils.aoa_to_sheet([header, ...data]);
    const colWidths=[]; [header, ...data].forEach(row=>row.forEach((cell,i)=>{ const len=(cell?cell.toString(): '').length; colWidths[i]=Math.max(colWidths[i]||10, len+2); }));
    ws['!cols']=colWidths.map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb, ws, 'Dienstplan');

    try{ XLSX.writeFile(wb, `${buildBaseFileName()}.xlsx`, { compression:true }); }
    catch{ const out=XLSX.write(wb,{bookType:'xlsx', type:'array', compression:true}); const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${buildBaseFileName()}.xlsx`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000); }
  }catch(err){ console.error(err); alert('Excel-Export fehlgeschlagen. Details in der Konsole.'); }
}

/* ========= Buttons / Sichtbarkeit ========= */
document.getElementById('btnCsv').addEventListener('click', exportCsv);
document.getElementById('btnPdf').addEventListener('click', exportPdf);
document.getElementById('btnIcs').addEventListener('click', exportIcs);
document.getElementById('btnXlsx').addEventListener('click', exportXlsx);

const btnToTop=$('#btnToTop'), btnToResults=$('#btnToResults'), btnToExport=$('#btnToExport');
function hasResultsVisible(){ return !$('#ergebnisTabelle').classList.contains('hidden'); }
function mostlyInViewport(el){ if(!el) return false; const r=el.getBoundingClientRect(); const vh=window.innerHeight||document.documentElement.clientHeight; const vis=Math.max(0, Math.min(r.bottom, vh) - Math.max(r.top, 0)); return vis >= (r.height*0.6); }
function updateToTopVisibility(){ btnToTop.classList.toggle('show', window.scrollY>200); }
function updateResultsButtonVisibility(){ const show=hasResultsVisible() && !mostlyInViewport($('#ergebnisTitel')); btnToResults.classList.toggle('show', !!show); }
function updateExportButtonVisibility(){ const enabled = !$('#btnCsv').disabled || !$('#btnPdf').disabled || !$('#btnIcs').disabled || !$('#btnXlsx').disabled; btnToExport.classList.toggle('show', enabled); }

window.addEventListener('scroll', ()=>{ updateToTopVisibility(); updateResultsButtonVisibility(); }, { passive:true });
window.addEventListener('resize', ()=>{ updateToTopVisibility(); updateResultsButtonVisibility(); });

btnToTop.addEventListener('click', ()=>{ window.scrollTo({ top:0, behavior: prefersReduced?'auto':'smooth' }); try{ $('#pageTop').focus({preventScroll:true}); }catch{} });
btnToResults.addEventListener('click', ()=>{ const a=$('#ergebnisTitel'); if(a && hasResultsVisible()){ a.scrollIntoView({ behavior: prefersReduced?'auto':'smooth', block:'start' }); try{ a.focus({preventScroll:true}); }catch{} }});
btnToExport.addEventListener('click', ()=>{ $('#exportButtons')?.scrollIntoView({ behavior: prefersReduced?'auto':'smooth', block:'start' }); });

const exportObserver=new MutationObserver(()=> updateExportButtonVisibility());
['#btnCsv','#btnPdf','#btnIcs','#btnXlsx'].forEach(sel=>{ const el=$(sel); if(el) exportObserver.observe(el,{attributes:true, attributeFilter:['disabled','class']}); });

/* === Termine ermitteln === */
document.getElementById('btnBerechnen').addEventListener('click', async ()=>{
  try{
    if (!validateInputs()){ toggleExportButtons(false); updateResultsButtonVisibility(); updateToolbarVisibility(); return; }

    const bundesland=$('#bundesland').value;
    const subdivision=mapBundeslandToSubdivision(bundesland);
    const dienstAnFeiertagen=$('#feiertagsCheck').checked;
    const dienstInFerien=$('#ferienCheck').checked;

    const {minYear,maxYear}=getYearBounds();
    const jahre=new Set();
    document.querySelectorAll('#terminreihen-container > .terminreihe').forEach(r=>{
      const s=r.querySelector('.dienst_start').value; const e=r.querySelector('.dienst_ende').value;
      if(s){ const y=new Date(s).getFullYear(); if(y>=minYear&&y<=maxYear) jahre.add(y); }
      if(e){ const y2=new Date(e).getFullYear(); if(y2>=minYear&&y2<=maxYear) jahre.add(y2); }
    });
    if(jahre.size===0) jahre.add(new Date().getFullYear());

    const [feiertageMap, ferienMap]=await Promise.all([
      fetchPublicHolidaysForYears([...jahre], subdivision),
      fetchSchoolHolidaysForYears([...jahre], subdivision)
    ]);

    const tbody=$('#tabelleBody'); tbody.innerHTML=''; $('#ergebnisTabelle').classList.add('hidden');

    const tagZuIndex={Sonntag:0, Montag:1, Dienstag:2, Mittwoch:3, Donnerstag:4, Freitag:5, Samstag:6};
    const alleTermine=[];

    document.querySelectorAll('#terminreihen-container > .terminreihe').forEach(reihe=>{
      const bezO=reihe.querySelector('.dienst_bezeichnung').value;
      const woch=reihe.querySelector('.dienst_wochentag').value;
      const turn=reihe.querySelector('.dienst_turnus').value;
      const mpos =reihe.querySelector('.dienst_monat_position')?.value;
      const dS=new Date(reihe.querySelector('.dienst_start').value);
      const dE=new Date(reihe.querySelector('.dienst_ende').value);
      const tS=reihe.querySelector('.dienst_startzeit').value;
      const tE=reihe.querySelector('.dienst_endzeit').value;

      let cur=new Date(dS); const ziel=tagZuIndex[woch]; const termine=[];
      if (turn==='monatlich'){
        cur.setDate(1);
        while (cur<=dE){
          const y=cur.getFullYear(), m=cur.getMonth();
          const first=new Date(y,m,1), last=new Date(y,m+1,0);
          const tage=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) if(d.getDay()===ziel) tage.push(new Date(d));
          const idx=(mpos==='-1')? (tage.length-1): (parseInt(mpos||'1',10)-1);
          if(idx>=0 && idx<tage.length){ const ch=tage[idx]; if(ch>=dS && ch<=dE) termine.push(ch); }
          cur=new Date(y,m+1,1);
        }
      } else {
        while(cur.getDay()!==ziel) cur.setDate(cur.getDate()+1);
        while(cur<=dE){ if(cur>=dS) termine.push(new Date(cur)); cur.setDate(cur.getDate() + (turn==='2woechentlich'?14:7)); }
      }

      for (const d of termine){
        const iso=ymd(d);
        const ferienname = ferienMap[iso] || '';
        const feiertag   = feiertageMap[iso] || '';

        let bezeichnung=bezO; let hintType=''; let hintText='';

        if(!dienstInFerien && ferienname){ bezeichnung=`Entfällt: ${bezO}`; hintType='Ferien';    hintText=ferienname; }
        else if(!dienstAnFeiertagen && feiertag){ bezeichnung=`Entfällt: ${bezO}`; hintType='Feiertag'; hintText=feiertag; }
        else if(feiertag){ hintType='Feiertag'; hintText=feiertag; }

        alleTermine.push({ datum:d, iso, bezeichnung, zeitStart:tS, zeitEnde:tE, hintType, hintText });
      }
    });

    // Sortieren (Datum)
    alleTermine.sort((a,b)=>a.datum - b.datum);

    // Rendern
    alleTermine.forEach(x=>{
      const tr=document.createElement('tr');

      tr.dataset.dateIso   = x.iso;
      tr.dataset.dienstRaw = x.bezeichnung;
      tr.dataset.hint      = x.hintText || '';
      tr.dataset.timeStart = x.zeitStart || '';
      tr.dataset.timeEnd   = x.zeitEnde  || '';

      if(x.hintText) tr.classList.add('feiertag-row');
      const day=x.datum.getDay(); if(day===0||day===6) tr.classList.add('wknd');

      const isCancelled=/^Entfällt:\s*/i.test(x.bezeichnung);
      const dienstTitle=isCancelled? x.bezeichnung.replace(/^Entfällt:\s*/i,'') : x.bezeichnung;
      const dienstCell=isCancelled ? `${dienstTitle} <span class="chip chip-cancel">Entfällt</span>` : dienstTitle;
      const hintCell=x.hintText ? `<span class="chip chip-info">${x.hintType}</span> ${x.hintText}` : '';

      tr.innerHTML=`
        <td class="border px-4 py-2">${String(x.datum.getDate()).padStart(2,'0')}.${String(x.datum.getMonth()+1).padStart(2,'0')}.${x.datum.getFullYear()}</td>
        <td class="border px-4 py-2">${['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][day]}</td>
        <td class="border px-4 py-2">${dienstCell}</td>
        <td class="border px-4 py-2">${displayTimeRange(x.zeitStart, x.zeitEnde)}</td>
        <td class="border px-4 py-2">${hintCell}</td>`;
      $('#tabelleBody').appendChild(tr);
    });

    const hasRows=alleTermine.length>0, tableEl=$('#ergebnisTabelle'), titleEl=$('#ergebnisTitel'), dividerEl=$('#ergebnisDivider');
    if(hasRows){
      tableEl.classList.remove('hidden'); titleEl.classList.remove('hidden'); dividerEl.classList.remove('hidden'); toggleExportButtons(true);

      // Toolbar anzeigen, Features aktivieren
      updateToolbarVisibility();
      attachTableFeatures();

      requestAnimationFrame(()=>{ titleEl.scrollIntoView({behavior: prefersReduced?'auto':'smooth', block:'start'}); try{ titleEl.focus({preventScroll:true}); }catch{} updateToTopVisibility(); });
    } else {
      tableEl.classList.add('hidden'); titleEl.classList.add('hidden'); dividerEl.classList.add('hidden'); toggleExportButtons(false);
      updateToolbarVisibility();
      alert('Keine gültigen Termine ermittelt.');
    }
  }catch(err){
    console.error(err);
    alert('Es ist ein Fehler beim Ermitteln der Termine aufgetreten: ' + (err?.message || err));
  }
});

/* ========= Buttons / Sichtbarkeit ========= */
document.getElementById('btnCsv').addEventListener('click', exportCsv);
document.getElementById('btnPdf').addEventListener('click', exportPdf);
document.getElementById('btnIcs').addEventListener('click', exportIcs);
document.getElementById('btnXlsx').addEventListener('click', exportXlsx);

function getBundeslandText(){ const opt=$('#bundesland option:checked'); const t=(opt?.textContent||'').trim(); return t && t!=='Bitte wählen' ? t : ''; }

function mapBundeslandToSubdivision(bl){
  const m={'BW':'DE-BW','BY':'DE-BY','BE':'DE-BE','BB':'DE-BB','HB':'DE-HB','HH':'DE-HH','HE':'DE-HE','MV':'DE-MV','NI':'DE-NI','NW':'DE-NW','RP':'DE-RP','SL':'DE-SL','SN':'DE-SN','ST':'DE-ST','SH':'DE-SH','TH':'DE-TH'};
  return m[bl]||'';
}
async function fetchPublicHolidaysForYears(years, subdivision){
  const map={}; const base='https://openholidaysapi.org/PublicHolidays';
  const qs=(y,useSubdivision=true)=> base+`?countryIsoCode=DE&languageIsoCode=DE&validFrom=${y}-01-01&validTo=${y}-12-31`+(useSubdivision&&subdivision?`&subdivisionCode=${encodeURIComponent(subdivision)}`:'');
  for(const y of years){
    try{
      let res=await fetch(qs(y,true),{ headers:{'accept':'application/json'} }); let data=res.ok?await res.json():null;
      if(!res.ok || !Array.isArray(data) || data.length===0){ res=await fetch(qs(y,false),{ headers:{'accept':'application/json'} }); data=res.ok?await res.json():[]; }
      (data||[]).forEach(item=>{ const name=extractName(item) || item?.englishName || ''; const start=item?.startDate || item?.validFrom || item?.date || ''; const end=item?.endDate || item?.validTo || item?.date || ''; addRangeDatesToMap(map,start,end,name); });
    }catch(e){}
  }
  return map;
}
async function fetchSchoolHolidaysForYears(years, subdivision){
  const map={}; if(!subdivision) return map;
  const base='https://openholidaysapi.org/SchoolHolidays';
  const qs=(y)=> base+`?countryIsoCode=DE&subdivisionCode=${encodeURIComponent(subdivision)}&languageIsoCode=DE&validFrom=${y}-01-01&validTo=${y}-12-31`;
  for(const y of years){
    try{
      const res=await fetch(qs(y),{ headers:{'accept':'application/json'} }); if(!res.ok) continue;
      const data=await res.json();
      (data||[]).forEach(item=>{ const name=extractName(item) || item?.englishName || 'Ferien'; const start=item?.startDate || item?.validFrom || ''; const end=item?.endDate || item?.validTo || start; addRangeDatesToMap(map,start,end,name); });
    }catch(e){}
  }
  return map;
}
function extractName(obj){
  const n=obj?.name; if(!n) return '';
  if(typeof n==='string') return n;
  if(Array.isArray(n)){ const de=n.find(x=>x.language==='DE'||x.languageIsoCode==='DE'); return (de?.text||de?.name||n[0]?.text||n[0]?.name||'').toString(); }
  return String(n);
}
function addRangeDatesToMap(map, startStr, endStr, name){
  if(!startStr) return;
  const s=ymdToLocalDate(startStr.slice(0,10));
  const e=ymdToLocalDate((endStr||startStr).slice(0,10));
  for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
    const key=ymd(d); map[key]=map[key]? map[key]+' / '+name: name;
  }
}

/* ========= Ende ========= */
  </script>
</body>
</html>
